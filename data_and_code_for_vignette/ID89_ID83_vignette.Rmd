---
title: "ID89 and ID83 vignette"
output:
  html_document: default
  pdf_document: default
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
library(magrittr)
library(indelsig.tools.lib)
library(gridExtra)
library(data.table)
library(ICAMS)
library(ggplot2)
library(magick)   
source("Koh89_Koh476_Plotting_Functions.R")
# è¾“å‡ºç›®å½•è®¾ç½®
output_dir <- "../www"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
ID89_ID83_connection_example <- data.table::fread("ID89_ID83_connection_example1.txt")
colnames(ID89_ID83_connection_example) <- c("ID89_signature","example_catalog","ID83_signature")
to.plot.WGS_PCAWG_HMF_indels.catalog <- data.table::fread("../Manuscript_data/Liu_et_al_83_type_catalog.txt")
to.plot.WGS_PCAWG_HMF_indels.catalog <- ICAMS::as.catalog(to.plot.WGS_PCAWG_HMF_indels.catalog[,-1],infer.rownames = T)
to.plot.WGS_PCAWG_HMF_indels.catalog.no.polyT <- to.plot.WGS_PCAWG_HMF_indels.catalog
to.plot.WGS_PCAWG_HMF_indels.catalog.no.polyT[c(12,24),] <- 0
to.plot.all.signatures.final <- as.data.frame(data.table::fread("../Manuscript_data/Liu_et_al_final_83_type_signatures.txt"))
to.plot.all.signatures.final <- to.plot.all.signatures.final[,-1]
to.plot.all.signatures.final <- ICAMS::as.catalog(to.plot.all.signatures.final,infer.rownames = T,catalog.type = "counts.signature")

to.plot.all.ID89.signatures.final <- as.data.frame(data.table::fread("../Manuscript_data/Liu_et_al_final_89_type_signatures.txt"))
row.names(to.plot.all.ID89.signatures.final)<- to.plot.all.ID89.signatures.final[,1]  # Use the first column as row names

# Optionally, remove the first column from the data table
to.plot.all.ID89.signatures.final <- to.plot.all.ID89.signatures.final[, -1]

to.plot.all.ID89.catalogs <- as.data.frame(data.table::fread("../Manuscript_data/Liu_et_al_89_type_catalog.txt"))
row.names(to.plot.all.ID89.catalogs)<- to.plot.all.ID89.catalogs[,1]  # Use the first column as row names

# Optionally, remove the first column from the data table
to.plot.all.ID89.catalogs <- to.plot.all.ID89.catalogs[, -1]

ID89.mSigAct.assignment <- readRDS("ID89.mSigAct.assignment.rds")

final.Koh476.signatures <- as.data.frame(data.table::fread("../Manuscript_data/Liu_et_al_final_476_type_signatures.txt"))
row.names(final.Koh476.signatures)<- final.Koh476.signatures[,1]  # Use the first column as row names

# Optionally, remove the first column from the data table
final.Koh476.signatures <- final.Koh476.signatures[, -1]

to.plot.all.ID476.catalogs <- as.data.frame(data.table::fread("../Manuscript_data/Liu_et_al_476_type_catalog.txt"))
row.names(to.plot.all.ID476.catalogs)<- to.plot.all.ID476.catalogs[,1]  # Use the first column as row names

# Optionally, remove the first column from the data table
to.plot.all.ID476.catalogs <- to.plot.all.ID476.catalogs[, -1]

```



```{r,fig.width=19,fig.height=3, echo=FALSE, results="asis", warning = FALSE }
par(mfrow = c(1, 2))  # Set layout to 2x2
total_rows <- nrow(ID89_ID83_connection_example)
cat(paste0("å¼€å§‹å¤„ç† ", total_rows, " ä¸ª Signature...\n"))

for (i in 1:total_rows) {
  
  # Get the current signature and catalog
  ID89signature <- ID89_ID83_connection_example$ID89_signature[i]
  catalog <- ID89_ID83_connection_example$example_catalog[i]
  ID83signature <- ID89_ID83_connection_example$ID83_signature[i]
  
  # ==============================================================================
  # åˆ†æ”¯ 1: å¤„ç† InsDel15 å’Œ InsDel16 (ç‰¹æ®Šé€»è¾‘)
  # ==============================================================================
  if(ID89signature %in% c("InsDel15","InsDel16")){
    cat(paste0("\n\n### ", ID89signature, " \n\n  83-Type Signature: ", 
               ID83signature,
               " \n\n  The signature contribute all mutations of the example spectrum: ", catalog, "\n\n"))
    
    # 1. Koh89 Signature Spectrum
    p1 <- PlotKoh89Catalog(to.plot.all.ID89.signatures.final[,ID89signature,drop=F], text_size = 6, plot_title = ID89signature, ylabel="Props")
    p1 <- p1 + theme(strip.text = element_text(size = 15, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_signature.89spectrum.png")), 
           plot = p1, width = 16, height = 6, dpi = 300)
    
    # 2. Koh89 Thumbnail
    p1_thumb_raw <- PlotKoh89Catalog(
      to.plot.all.ID89.signatures.final[,ID89signature,drop=F],
      text_size = 0.8, 
      plot_title = ID89signature, 
      ylabel="Props"
    )
    p1_thumb <- p1_thumb_raw + 
      theme_void() + 
      theme(
        plot.title = element_blank(), axis.text = element_blank(),
        axis.title = element_blank(), axis.ticks = element_blank(),
        legend.position = "none", plot.margin = margin(0,0,0,0)
      ) +
      labs(title = NULL, x = NULL, y = NULL)
    
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "89Thumbnail.png")), 
           plot = p1_thumb, width = 4, height = 1, dpi = 300)
    
    # 3. Spectrum A (No cosine calc here in original code, assumed 1?)
    # æ³¨æ„ï¼šåŸä»£ç è¿™é‡Œçš„ cosine1 å˜é‡å¯èƒ½æœªå®šä¹‰ï¼Œå¦‚æœæŠ¥é”™è¯·æ‰‹åŠ¨èµ‹å€¼ cosine1 <- 1
    cosine1 <- 1 
    p2 <- PlotKoh89Catalog(to.plot.all.ID89.catalogs[,catalog,drop=F],
                           text_size = 5,
                           plot_title = paste0("Spectrum A: Mutational spectrum of ",
                                               catalog,
                                               " \n Cosine Similarity to ",
                                               ID89signature, " = ", cosine1))
    p2 <- p2 + theme(strip.text = element_text(size = 15, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_89spectrumA.png")), 
           plot = p2, width = 16, height = 6, dpi = 300)
    
    # 4. 476-Type Plot
    p5 <- PlotKoh476Catalog(final.Koh476.signatures[,ID89signature], text_size = 6, plot_title = paste0("476-Type Representation of ",ID89signature,sep=""), top.types.to.show = 5)
    p5 <- p5 + theme(strip.text = element_text(size = 35, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_476all.png")), 
           plot = p5, width = 42, height = 6, dpi = 600, limitsize = FALSE)
    
    # --- [ä¿®å¤æ ¸å¿ƒ] ä¿å­˜ ID83 å›¾ç‰‡ ---
    # ä¹‹å‰è¿™é‡Œåªæœ‰ ICAMS::PlotCatalog(...)ï¼Œæ²¡æœ‰ png()ï¼Œæ‰€ä»¥å›¾ä¸¢äº†ã€‚
    
    # Save ID83 Signature
    png(filename = file.path(output_dir, paste0(ID89signature, "_", ID83signature, "_83all.png")), 
        width = 16, height = 6, units = "in", res = 300)
    par(mar = c(4, 4, 4, 2), cex = 1.5, cex.axis = 1.2, cex.lab = 1.2, cex.main = 1.5)
    ICAMS::PlotCatalog(to.plot.all.signatures.final[,ID83signature,drop=F])
    dev.off()
    
    # Save ID83 Sample (Filtered)
    png(filename = file.path(output_dir, paste0(ID89signature, "_", ID83signature, "_83filtered.png")), 
        width = 16, height = 6, units = "in", res = 300)
    par(mar = c(4, 4, 4, 2), cex = 1.5, cex.axis = 1.2, cex.lab = 1.2, cex.main = 1.5)
    ICAMS::PlotCatalog(to.plot.WGS_PCAWG_HMF_indels.catalog[,catalog,drop=F])
    dev.off()
    
  # ==============================================================================
  # åˆ†æ”¯ 2: å¤„ç†å…¶ä»– Signatures (å¸¸è§„é€»è¾‘)
  # ==============================================================================
  } else {
    
    if(ID83signature %in% c("C_ID7","ID_J","C_ID10","ID_N","ID_O")){
      cat(paste0("\n\n### ", ID89signature, " \n\n  83-Type Signature: ", 
                 ID83signature,
                 " \n\n  Supporting spectrum (deletion and insertions in long poly T tracts were removed from the Indel83 spectrum): ", catalog, "\n\n"))
    }else{
      cat(paste0("\n\n### ", ID89signature, " \n\n  83-Type Signature: ", 
                 ID83signature," \n\n  Supporting spectrum: ", catalog, "\n\n"))
    }
    
    # ... è®¡ç®—é€»è¾‘ ...
    ID89.assignment.this.catalog <- ID89.mSigAct.assignment[,catalog,drop=F]
    ID89.assignment.this.catalog.other.signatures <- ID89.mSigAct.assignment[,catalog,drop=F]
    ID89.assignment.this.catalog.other.signatures[which(row.names(ID89.mSigAct.assignment)==ID89signature),] <- 0
    reconstructed.ID89.catalog <- as.matrix(to.plot.all.ID89.signatures.final[,c(1:44,46)]) %*% as.matrix(ID89.assignment.this.catalog.other.signatures)
    diff.catalog <- to.plot.all.ID89.catalogs[,catalog,drop=F] - reconstructed.ID89.catalog
    diff.catalog[diff.catalog<0] <- 0
    
    cosine1 <- round(lsa::cosine(as.numeric(to.plot.all.ID89.signatures.final[,ID89signature]),as.numeric(to.plot.all.ID89.catalogs[,catalog])),3)
    cosine2 <- round(lsa::cosine(as.numeric(to.plot.all.ID89.signatures.final[,ID89signature]),as.numeric(as.matrix(diff.catalog))),3)
    
    # 1. Koh89 Signature
    p1 <- PlotKoh89Catalog(to.plot.all.ID89.signatures.final[,ID89signature,drop=F],text_size = 6,plot_title = ID89signature,ylabel="Props")
    p1 <- p1 + theme(strip.text = element_text(size = 15, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_signature.89spectrum.png")), 
           plot = p1, width = 16, height = 6, dpi = 300)
    
    # 2. Thumbnail
    p1_thumb_raw <- PlotKoh89Catalog(to.plot.all.ID89.signatures.final[,ID89signature,drop=F],
                                     text_size = 0.8, plot_title = ID89signature, ylabel="Props")
    p1_thumb <- p1_thumb_raw + theme_void() + 
      theme(plot.title=element_blank(), axis.text=element_blank(), axis.title=element_blank(),
            axis.ticks=element_blank(), legend.position="none", plot.margin=margin(0,0,0,0)) +
      labs(title=NULL, x=NULL, y=NULL)
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "89Thumbnail.png")), 
           plot = p1_thumb, width = 4, height = 1, dpi = 300)
    
    # 3. Spectrum A
    p2 <- PlotKoh89Catalog(to.plot.all.ID89.catalogs[,catalog,drop=F],
                           text_size = 5,
                           plot_title = paste0("Spectrum A: Mutational spectrum of ",
                                               catalog,
                                               " | Cosine Similarity to ",
                                               ID89signature, " = ", cosine1))
    p2 <- p2 + theme(strip.text = element_text(size = 15, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_89spectrumA.png")), 
           plot = p2, width = 16, height = 6, dpi = 300)
    
    # 4. Spectrum B
    p3 <- PlotKoh89Catalog(reconstructed.ID89.catalog,text_size = 5,
                           plot_title = paste0("Spectrum B: Partial mutational spectrum of ",
                                               catalog, " not using ",ID89signature),
                           setyaxis = max(diff.catalog))
    p3 <- p3 + theme(strip.text = element_text(size = 15, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_89spectrumB.png")), 
           plot = p3, width = 16, height = 6, dpi = 300)
    
    # 5. Spectrum C
    p4 <- PlotKoh89Catalog(diff.catalog,text_size = 5,plot_title = paste0("Mutations due to ", ID89signature, " (A minus B)| Cosine similarity to ", ID89signature, " = :", cosine2))
    p4 <- p4 + theme(strip.text = element_text(size = 15, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_89spectrumC.png")), 
           plot = p4, width = 16, height = 6, dpi = 300)
    
    # 6. Koh476
    if(ID89signature %in% colnames(final.Koh476.signatures)){
      p5 <- PlotKoh476Catalog(final.Koh476.signatures[,ID89signature],text_size = 3,plot_title = paste0("476-Type Representation of ",ID89signature,sep=""),top.types.to.show = 5)
    }else{
      cat(paste0("\n\n 476-Type ",ID89signature, " was not found. Here shows the 476-Type Spectrum of ",catalog))
      p5 <- PlotKoh476Catalog(to.plot.all.ID476.catalogs[,catalog],text_size = 6,plot_title = paste0("476-Type Representation of the Supporting Genome ",catalog,sep=""),top.types.to.show = 5)
    }
    p5 <- p5 + theme(strip.text = element_text(size = 35, face = "bold"))
    ggsave(filename = file.path(output_dir, paste0(ID89signature, "_476all.png")), 
           plot = p5, width = 42, height = 6, dpi = 600, limitsize = FALSE)
    
    # --- ä¿å­˜ ID83 å›¾ç‰‡ (å¸¸è§„é€»è¾‘) ---
    png(filename = file.path(output_dir, paste0(ID89signature, "_", ID83signature, "_83all.png")), 
        width = 16, height = 6, units = "in", res = 300)
    par(mar = c(4, 4, 4, 2), cex = 1.5, cex.axis = 1.2, cex.lab = 1.2, cex.main = 1.5)
    ICAMS::PlotCatalog(to.plot.all.signatures.final[,ID83signature,drop=F])
    dev.off()
    
    png(filename = file.path(output_dir, paste0(ID89signature, "_", ID83signature, "_83filtered.png")), 
        width = 16, height = 6, units = "in", res = 300)
    par(mar = c(4, 4, 4, 2), cex = 1.5, cex.axis = 1.2, cex.lab = 1.2, cex.main = 1.5)
    if(ID83signature %in% c("C_ID7","ID_J","C_ID10","ID_N","ID_O")){
      ICAMS::PlotCatalog(to.plot.WGS_PCAWG_HMF_indels.catalog.no.polyT[,catalog,drop=F])
    }else{
      ICAMS::PlotCatalog(to.plot.WGS_PCAWG_HMF_indels.catalog[,catalog,drop=F])
    }
    dev.off()
  } # End of else
  
  # ==============================================================================
  # é€šç”¨æ­¥éª¤ï¼šç”Ÿæˆ ID83 ç¼©ç•¥å›¾ (æ‰€æœ‰ç­¾åéƒ½è¦åš)
  # ==============================================================================
  thumb_file <- file.path(output_dir, paste0(ID83signature, "_Thumbnail.png"))
  # åªæœ‰å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶æ‰ç”Ÿæˆï¼Œæˆ–è€…å¼ºåˆ¶ç”Ÿæˆ (TRUE)
  if (!file.exists(thumb_file) || TRUE) { 
    temp_png <- tempfile(fileext = ".png")
    tryCatch({
      # 1. ä¸´æ—¶ç”»ä¸€å¼ å¤§å›¾
      png(filename = temp_png, width = 4800, height = 1300, res = 300)
      par(mar = c(1, 4, 5, 1))
      ICAMS::PlotCatalog(to.plot.all.signatures.final[,ID83signature,drop=F])
      dev.off()
      
      # 2. ç”¨ magick è£å‰ªç”Ÿæˆç¼©ç•¥å›¾
      img <- image_read(temp_png)
      img_clean <- image_crop(img, "4450x1300+350+0")
      img_thumb <- image_resize(img_clean, "1500x")
      image_write(img_thumb, path = thumb_file)
      
    }, error = function(e) {
      message(paste0("   ID83 ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥ (", ID83signature, "): ", e$message))
      # å¦‚æœå‡ºé”™æ—¶è®¾å¤‡è¿˜å¼€ç€ï¼Œå…³é—­å®ƒ
      if (dev.cur() > 1) dev.off()
    })
    if (file.exists(temp_png)) unlink(temp_png)
  }
  
} # End of loop

cat("\nğŸ‰ æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆå®Œæ¯•ï¼\n")